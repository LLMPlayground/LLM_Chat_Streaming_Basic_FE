<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Giao diện Streaming cho GitHub AI</title>
    <!-- Sử dụng Tailwind CSS để giao diện đẹp hơn -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
      /* Thêm hiệu ứng gõ chữ cho con trỏ */
      #cursor {
        animation: blink 1s step-end infinite;
      }
      @keyframes blink {
        from,
        to {
          background-color: transparent;
        }
        50% {
          background-color: #2dd4bf;
        } /* teal-400 */
      }
      /* Style cho scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1f2937; /* gray-800 */
      }
      ::-webkit-scrollbar-thumb {
        background: #374151; /* gray-700 */
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #4b5563; /* gray-600 */
      }
    </style>
  </head>
  <body
    class="bg-gray-900 text-gray-200 font-sans flex items-center justify-center min-h-screen">
    <div
      class="w-full max-w-3xl bg-gray-800 rounded-2xl shadow-2xl flex flex-col"
      style="height: 90vh">
      <header class="p-4 border-b border-gray-700">
        <h1 class="text-xl font-bold text-center text-teal-400">
          Giao diện Chat Streaming
        </h1>
      </header>

      <main id="chat-container" class="flex-1 p-6 overflow-y-auto">
        <!-- Vùng hiển thị tin nhắn -->
        <div id="message-list" class="space-y-6">
          <!-- Tin nhắn của bot -->
          <div class="flex items-start gap-4">
            <div
              class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center">
              <i class="fas fa-robot text-teal-400"></i>
            </div>
            <div class="bg-gray-700 rounded-lg p-4 flex-1">
              <p>Xin chào! Bạn muốn hỏi tôi điều gì?</p>
            </div>
          </div>
        </div>
      </main>

      <footer class="p-4 border-t border-gray-700">
        <div class="bg-gray-700 rounded-lg flex items-center p-2">
          <textarea
            id="prompt-input"
            class="flex-1 bg-transparent text-gray-200 focus:outline-none p-2 resize-none"
            rows="1"
            placeholder="Nhập câu hỏi của bạn..."></textarea>
          <button
            id="send-button"
            class="ml-2 bg-teal-600 hover:bg-teal-700 rounded-lg p-3 text-white transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
        <div class="p-2 text-center text-sm text-yellow-500">
          <i class="fas fa-exclamation-triangle mr-1"></i>
          <strong>Lưu ý:</strong> Cần thiết lập `GITHUB_TOKEN` để ứng dụng hoạt
          động.
        </div>
      </footer>
    </div>

    <script>
      // --- CẤU HÌNH ---
      // Lấy token từ biến môi trường (nếu có) hoặc điền trực tiếp vào đây
      // QUAN TRỌNG: Không bao giờ để lộ token trong code khi triển khai lên public!
      const githubToken = ""; // <<< HÃY ĐIỀN GITHUB TOKEN CỦA BẠN VÀO ĐÂY
      const endpoint = "https://models.github.ai/inference/chat/completions";
      const model = "openai/gpt-4.1";

      // Lấy các element từ DOM
      const sendButton = document.getElementById("send-button");
      const promptInput = document.getElementById("prompt-input");
      const messageList = document.getElementById("message-list");
      const chatContainer = document.getElementById("chat-container");

      // Tự động điều chỉnh chiều cao của textarea
      promptInput.addEventListener("input", () => {
        promptInput.style.height = "auto";
        promptInput.style.height = promptInput.scrollHeight + "px";
      });

      // Gửi tin nhắn khi nhấn nút hoặc nhấn Enter
      sendButton.addEventListener("click", handleSendMessage);
      promptInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          handleSendMessage();
        }
      });

      function handleSendMessage() {
        const prompt = promptInput.value.trim();
        if (!prompt || sendButton.disabled) {
          return;
        }

        if (!githubToken) {
          alert("Lỗi: Vui lòng điền GITHUB_TOKEN vào trong file code.");
          return;
        }

        // Hiển thị tin nhắn của người dùng
        appendMessage(prompt, "user");

        // Xóa nội dung input và vô hiệu hóa nút gửi
        promptInput.value = "";
        promptInput.style.height = "auto";
        sendButton.disabled = true;

        // Bắt đầu quá trình streaming từ AI
        streamAIResponse();
      }

      // Hàm thêm tin nhắn vào giao diện
      function appendMessage(content, role) {
        const messageDiv = document.createElement("div");
        if (role === "user") {
          messageDiv.className = "flex items-start gap-4 flex-row-reverse";
          messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center">
                        <i class="fas fa-user text-blue-400"></i>
                    </div>
                    <div class="bg-blue-600 rounded-lg p-4 flex-1">
                        <p>${content}</p>
                    </div>
                `;
        } else {
          // role === 'assistant'
          messageDiv.className = "flex items-start gap-4";
          messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center">
                        <i class="fas fa-robot text-teal-400"></i>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-4 flex-1">
                        <p id="streaming-response"></p>
                        <span id="cursor" class="inline-block w-2 h-4 -mb-1"></span>
                    </div>
                `;
        }
        messageList.appendChild(messageDiv);
        scrollToBottom();
        return messageDiv;
      }

      async function streamAIResponse() {
        // Lấy toàn bộ lịch sử chat để gửi làm context
        const messages = Array.from(messageList.children).map((msg) => {
          const role = msg.querySelector(".fa-user") ? "user" : "assistant";
          const content = msg.querySelector("p").textContent;
          return { role, content };
        });

        // Tạo một vị trí để hiển thị phản hồi streaming
        appendMessage("", "assistant");
        const responseElement = document.getElementById("streaming-response");
        const cursorElement = document.getElementById("cursor");

        try {
          const response = await fetch(endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${githubToken}`,
            },
            body: JSON.stringify({
              model: model,
              messages: messages,
              stream: true,
            }),
          });

          if (!response.ok) {
            const err = await response.json();
            throw new Error(
              err.error?.message || `Lỗi HTTP ${response.status}`
            );
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split("\n");

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                const dataStr = line.substring(6).trim();
                if (dataStr === "[DONE]") {
                  return; // Kết thúc stream
                }
                try {
                  const jsonData = JSON.parse(dataStr);
                  const content = jsonData.choices[0]?.delta?.content || "";
                  responseElement.textContent += content;
                  scrollToBottom();
                } catch (e) {
                  // Bỏ qua các dòng không phải JSON
                }
              }
            }
          }
        } catch (error) {
          responseElement.textContent = `Lỗi: ${error.message}`;
        } finally {
          // Kích hoạt lại nút gửi và ẩn con trỏ
          sendButton.disabled = false;
          if (cursorElement) {
            cursorElement.remove();
          }
          // Xóa id để tránh trùng lặp
          if (responseElement) {
            responseElement.id = "";
          }
        }
      }

      function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    </script>
  </body>
</html>
